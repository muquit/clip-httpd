//go:build systray

package main

import (
	"fmt"
	"log"
	"os"
	"runtime"
	"os/exec"

	"github.com/getlantern/systray"
)

var globalSigChan chan os.Signal
var globalPort int

func initSystray(sigChan chan os.Signal, port int) {
	fmt.Println("Starting system tray mode...")
	
	globalSigChan = sigChan
	globalPort = port
	
	systray.Run(onReady, onExit)
}

func onReady() {
	fmt.Println("System tray ready!")
	
	// does not seem to work reliably
//	systray.SetIcon(getIcon())
	// just use a emoji in the title
	systray.SetTitle("ðŸ“‹ ClipHTTPD")
	systray.SetTooltip("ClipHTTPD Clipboard Server")

	mStatus := systray.AddMenuItem(fmt.Sprintf("Status: Running"), "Current status")
	mStatus.Disable() 
	mStatus = systray.AddMenuItem(fmt.Sprintf("Port %d", globalPort), "Listening on Port")
	mStatus.Disable() 

	systray.AddSeparator()

	mAbout := systray.AddMenuItem("About", "About ClipHTTPD")

	systray.AddSeparator()

	mExit := systray.AddMenuItem("Exit", "Exit ClipHTTPD")

	// start the timestamp writing in the background
	go func() {
		for {
			select {
			case sig := <-globalSigChan:
				fmt.Printf("\nReceived signal: %v\n", sig)
				systray.Quit()
				return
			}
		}
	}()

	// handle menu item clicks
	go func() {
		for {
			select {
			case <-mAbout.ClickedCh:
				showAbout()
			case <-mExit.ClickedCh:
				fmt.Println("Quit requested from system tray")
				systray.Quit()
				return
			}
		}
	}()
}

func onExit() {
	log.Println("Time Logger exiting...")
}

func showAbout() {
	openBrowser("https://github.com/muquit/clip-httpd")
}

func openBrowser(url string) {
	var err error
	
	switch runtime.GOOS {
	case "linux":
		err = exec.Command("xdg-open", url).Start()
	case "windows":
		err = exec.Command("rundll32", "url.dll,FileProtocolHandler", url).Start()
	case "darwin":
		err = exec.Command("open", url).Start()
	default:
		err = fmt.Errorf("unsupported platform")
	}
	
	if err != nil {
		log.Printf("Failed to open browser: %v", err)
		log.Printf("Please visit: %s", url)
	} else {
		log.Printf("Opening browser to: %s", url)
	}
}

//not used
func getIcon() []byte {
	return []byte{
		0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A, 0x00, 0x00, 0x00, 0x0D,
		0x49, 0x48, 0x44, 0x52, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x10,
		0x08, 0x06, 0x00, 0x00, 0x00, 0x1F, 0xF3, 0xFF, 0x61, 0x00, 0x00, 0x00,
		0x85, 0x49, 0x44, 0x41, 0x54, 0x38, 0x8D, 0x63, 0xF8, 0x0F, 0xC3, 0xC0,
		0xC0, 0xC0, 0x00, 0x02, 0x08, 0x20, 0x80, 0x00, 0x02, 0x08, 0x20, 0x80,
		0x00, 0x02, 0x08, 0x20, 0x80, 0x00, 0x02, 0x08, 0x20, 0x80, 0x00, 0x82,
		0xFF, 0xFF, 0xFF, 0x03, 0x04, 0x10, 0x40, 0x00, 0x01, 0x04, 0x10, 0x40,
		0x00, 0x01, 0x04, 0x10, 0x40, 0x00, 0x01, 0x04, 0x10, 0x40, 0x00, 0x01,
		0x04, 0x10, 0x40, 0x00, 0x01, 0x04, 0x10, 0x40, 0x00, 0x01, 0x04, 0x10,
		0x40, 0x00, 0x01, 0x04, 0x10, 0x40, 0x00, 0x01, 0x04, 0x10, 0x40, 0x00,
		0x01, 0x04, 0x10, 0x40, 0x00, 0x01, 0x04, 0x10, 0x40, 0x00, 0x01, 0x04,
		0x10, 0x40, 0x00, 0x01, 0x04, 0x10, 0x40, 0x00, 0x01, 0xFC, 0xFF, 0xFF,
		0xFF, 0x01, 0x04, 0x10, 0x40, 0x00, 0x01, 0x04, 0x10, 0x40, 0x00, 0x01,
		0x04, 0x10, 0x40, 0x00, 0x01, 0x04, 0x10, 0x40, 0x00, 0x81, 0xFF, 0xFF,
		0xFF, 0x07, 0x00, 0x00, 0x00, 0x00, 0x49, 0x45, 0x4E, 0x44, 0xAE, 0x42,
		0x60, 0x82,
	}
}
